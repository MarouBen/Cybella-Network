{% extends "network/layout.html" %}
{% load static %}

{% block body %}
    <div class="w-full  mx-auto bg-gray-800 p-2 text-white border-b border-gray-600">
        <form method="Post" action="{% url 'index' %}" enctype="multipart/form-data">
            {%csrf_token%}

            <div class="flex">
                {%if user.is_authenticated %}
                    <img class="w-14 h-12 rounded-full mr-2" src="{{user.picture.url}}" alt="Profile Avatar">
                {%else%}
                    <img class="w-14 h-12 rounded-full mr-2" src="{% static 'network/Images/default.png' %}" alt="Profile Avatar">
                {%endif%}
                
                <div class="w-full text-xl">
                    <textarea name="content" oninput="resize()" class="text-xl h-12 w-full p-2 bg-gray-800 overflow-y-hidden resize-none focus:outline-offset-0 focus:ring-0  border-0 focus:border-b focus:border-gray-600" 
                        placeholder="What's happening?"></textarea>
                    <div id="images-container" class=""></div>
                </div>
            </div>

            <div class="flex justify-between mt-2 ml-14">
                <label for="I" class=" flex items-center hover:cursor-pointer rounded-full hover:bg-sky-400 hover:bg-opacity-10 px-2.5" alt="Media">
                    <i class="fa-solid fa-image text-[20px] text-sky-500"></i>
                    <input type="file" name="I" id="I" value="{{I}}" accept="image/*,jpg,jpeg,png" onchange="previewImages()" hidden/>
                </label>
                <button class="tweet w-[20%] px-1 py-2" type="submit"> <span>Post</span></button>
            </div>

        </form>

    </div>
    {%for post in posts%}
        <div id="posts" class="w-full mx-auto bg-gray-800 pb-1 p-2 text-white border-b border-gray-600">
            <div class="flex">
                <img class="w-14 h-12 rounded-full mr-2" src="{{post.user.picture.url}}" alt="user Avatar">
                
                <div class="w-full">
                    <div class="flex justify-between">
                        <div>
                            <span class="font-bold">{{post.user|title}}</span>
                            <span class="text-gray-500 text-[13px]">{{post.timestamp|timesince}} ago</span>
                            <span class="text-gray-500 text-[13px]">â€¢</span>
                            <span class="text-gray-500 text-[13px]">Public</span>
                        </div>
                        <div>
                            <i class="fa-solid fa-ellipsis-h text-gray-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="text-md w-full pl-0 pt-0 p-2 bg-gray-800 ">{{post.content}}</div>
                    {% if post.images %}
                        <div id="images-container" class="">
                            <img class="max-w-xs max-h-xs rounded" src="{{post.images.url}}" alt="post image"> 
                        </div> 
                    {%endif%}

                </div>
            </div>
            <div class="flex justify-between mt-1 mx-20 text-gray-500">
                <div class="flex hover:text-blue-400 hover:cursor-pointer"><i class="fa-regular fa-comment-dots text-xl rounded-full hover:bg-blue-400 hover:bg-opacity-20 p-2 "></i><span class="mt-1.5 ml-1">{{post.comments.count}}</span></div>
                {% if user not in post.likes.all%}
                    <div id="like" onclick="like(this,{{post.id}})" class="flex hover:text-rose-400 hover:cursor-pointer"><i class="fa-regular fa-heart text-xl rounded-full hover:bg-rose-400 hover:bg-opacity-20 p-2"></i><span class="mt-1.5 ml-1">{{post.likes.count}}</span></div>
                {%else%}
                    <div id="like" onclick="like(this,{{post.id}})" class="flex hover:text-rose-400 hover:cursor-pointer text-rose-400"><i class="fa-solid fa-heart text-xl rounded-full hover:bg-rose-400 hover:bg-opacity-20 p-2"></i><span class="mt-1.5 ml-1">{{post.likes.count}}</span></div>
                {%endif%}
                <div class="flex hover:text-emerald-500 hover:cursor-pointer"><i class="fa-solid fa-retweet text-xl rounded-full hover:bg-emerald-500 hover:bg-opacity-20 p-2"></i></div>
            </div>
        </div>
    {%endfor%}

    <div class="w-full mx-auto bg-gray-800 p-2 text-white border-b border-gray-600">
        <div class="flex justify-center">
            <div class="flex">
                {% if posts.has_previous %}
                    <a href="?page={{ posts.previous_page_number }}" class="text-gray-500 text-xl hover:text-blue-400 hover:cursor-pointer">Previous</a>
                {% endif %}
                <span class="text-gray-500 text-xl mx-2">Page {{ posts.number }} of {{ posts.paginator.num_pages }}</span>
                {% if posts.has_next %}
                    <a href="?page={{ posts.next_page_number }}" class="text-gray-500 text-xl hover:text-blue-400 hover:cursor-pointer">Next</a>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        // function that will resize the textarea
        function resize(){
            var text = document.querySelector('textarea');
            text.style.height = "auto";
            text.style.height = text.scrollHeight + "px";
        }
        // function that will preview the images
        function previewImages(){
            const preview = document.querySelector('#images-container');
            const files = document.querySelector('input[type=file]').files;
            preview.innerHTML = "";
            if(files){
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.addEventListener("load", function(){
                        const image = new Image();
                        image.title = file.name;
                        image.src = this.result;
                        image.classList.add("max-w-xs", "max-h-xs");
                        preview.appendChild(image);
                    });
                    reader.readAsDataURL(file);
                });
            }
        }
        // function that will like the post onclcik
        function like(element, id){
            //send a request to the server
            fetch(`/like/${id}`)
            .then(response => response.json())
            .then(result => {
                console.log(result);
            });

            //get the heart of the div that called the function
            const heart = element.querySelector('i');
            //change the color of the heart of the div that called the function
            element.classList.toggle("text-rose-400");
            heart.classList.toggle("fa-regular");
            heart.classList.toggle("fa-solid");
            //get the number of likes
            var likes = element.querySelector('span');
            //change the number of likes
            if(element.classList.contains("text-rose-400")){
                likes.innerHTML = parseInt(likes.innerHTML) + 1;
            }else{
                likes.innerHTML = parseInt(likes.innerHTML) - 1;
            }
        }
    </script>
{% endblock %}
{% block footer %}
    footer
{% endblock %}